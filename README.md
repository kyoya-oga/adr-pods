# AndroidÂ AirPodsÂ ProÂ 2Â Controller â€” ImplementationÂ Plan

## Goals

* Provide a **native FOSS Android app** (MITâ€‘licensed, no ads or tracking) that controls AirPodsÂ Proâ€¯2 on devices running **AndroidÂ 6.0Â (APIÂ 23) or later**.
* Deliver the **widest possible feature set without requiring root**; enable additional functions when root is available.
* Avoid Apple trademarks and proprietary images; UI follows MaterialÂ 3 design with darkâ€‘theme support.

---

## FeatureÂ Scope

### ðŸ”¹Â P0Â (MVPÂ â€“Â nonâ€‘root, mustâ€‘have)

1. **Connection & Autoâ€‘Reconnect**
   â€¢ Primary pathÂ â€“ BLE **L2CAPÂ CoC** (PSMÂ `0x1001`) transporting **AppleÂ AccessoryÂ ProtocolÂ (AAP)** packets.
   â€¢ FallbackÂ â€“ BLEÂ **GATT** Battery ServiceÂ (`0x180F`) when L2CAP is unavailable.
2. **Battery Status**Â (L / R / Case + charging state).
3. **Noise Control**Â â€“ toggle **ANCÂ / TransparencyÂ / Off** via AAPÂ OpcodeÂ `0x0D`.
4. **Compose UI**Â â€“ MaterialÂ 3, singleâ€‘screen MVP with darkâ€‘theme.

### ðŸ”¹Â P1Â (ExtensionÂ â€“Â nonâ€‘root)

5. **AdaptiveÂ Audio** & **ConversationalÂ Awareness**Â (AAPÂ OpcodesÂ `0x2E` / `0x28`).
6. **Inâ€‘Ear Detection**Â â†’ automatic play / pause through `MediaSession`.
7. **Caseâ€‘Open Popâ€‘Up**Â â€“ iOSâ€‘style banner when the lid opens.
8. **WearÂ OS Tile** & homeâ€‘screen **Widget** for quick controls.

### ðŸ”¹Â P2Â (ExperimentalÂ â€“Â root recommended)

9. **Head Gestures**Â for call answer / media control.
10. **Rename AirPods & advanced settings** (write operations that need patched Bluetooth stack).
11. **Generic support**Â for other AirPods / Beats generations.

---

## Nonâ€‘FunctionalÂ Requirements

| Category               | Requirement                                                                                        |
| ---------------------- | -------------------------------------------------------------------------------------------------- |
| **Language**           | KotlinÂ +Â Coroutines/Flow                                                                           |
| **UI**                 | JetpackÂ Compose + ComposeÂ forÂ WearÂ OS                                                              |
| **Architecture**       | MVVM â€‘â€‘ module split (see diagram)                                                                 |
| **Permissions**        | `BLUETOOTH_SCAN`, `BLUETOOTH_CONNECT`, `BLUETOOTH_ADVERTISE` (AndroidÂ 12+ with `neverForLocation`) |
| **Foreground Service** | `foregroundServiceType="connectedDevice"` (AndroidÂ 14+)                                            |
| **Privacy**            | No analytics, all data stored locally, offline operation                                           |
| **Distribution**       | GitHub releases & Fâ€‘Droid; PlayÂ Store optional                                                     |

### Architecture modules

```text
ui-compose â”€â–¶ AirPodsViewModel (StateFlow)
               â”‚
               â””â”€â–¶ core-ble
                     â”œâ”€ L2capManager   (APIÂ 29+)
                     â”œâ”€ GattManager    (all APIs)
                     â””â”€ AutoSwitch      (chooses best path)

core-aap  â”€â”€â–¶ AapParser â€¢ AapBuilder â€¢ PacketRouter
background â”€â–¶ ConnectedDeviceService (Fg) + AutoReconnectWorker (WorkManager)
```

---

## KeyÂ TechnicalÂ Points

* **BLEÂ L2CAP**: `BluetoothDevice#createL2capChannel(0x1001)` for creditâ€‘based CoC; socket wrapped in Kotlin I/O coroutines.
* **AAP Packet Format**: `HeaderÂ 4Â B` + `LengthÂ 2Â B` (LE) + `OpcodeÂ 1Â B` + `Payload`.
* **Fallback Strategy**: if L2CAP connect fails or phone <Â APIâ€¯29, switch to `GattManager`â€‘driven path (BatteryÂ Service and any discovered private UUIDs).
* **Inâ€‘Ear Detection**: subscribe to AAP Sensor notifications â†’ bridge to `MediaSession` for play/pause.
* **Energy Optimisation**: Scan filter on AppleÂ VIDÂ `0x004C`, 10â€¯min scan interval, rely on HCI events while connected.
* **Root Addâ€‘Ons**: optional Magisk module that patches `libbluetooth_jni.so` to fix stack bugs and unlock write operations.

---

## RisksÂ &Â Mitigations

| Risk                                     | Mitigation                                                         |
| ---------------------------------------- | ------------------------------------------------------------------ |
| **L2CAP unsupported on device**          | Autoâ€‘switch to GATT; publish compatibility list.                   |
| **Apple firmware updates break opcodes** | CI smokeâ€‘tests BLE packets; failâ€‘fast alerts.                      |
| **High power consumption**               | Intermittent scans; foreground service only while connected.       |
| **Google Play BG restrictions**          | Show mandatory UX prompt; declare correct `foregroundServiceType`. |

---

## OSSÂ References

* **LibrePods** â€“ complete AAP opcode catalogue.
* **CAPod** â€“ WearÂ OS implementation ideas.
* **AirPodsLikeNormal** â€“ rootâ€‘level gesture control.
* Android documentation â€“ BLEÂ L2CAP, GATT, and foreground services.
